"use strict";!function(e,t){function a(e){return e&&e.__esModule?e:{default:e}}var n=e.exports={};window=t("../../npm/labrador/global.js");Object.defineProperty(n,"__esModule",{value:!0});var r=t("../../npm/babel-runtime/helpers/defineProperty.js"),u=a(r),s=t("../../npm/babel-runtime/regenerator/index.js"),o=a(s),i=t("../../npm/babel-runtime/helpers/asyncToGenerator.js"),l=a(i),c=t("../../npm/babel-runtime/core-js/object/get-prototype-of.js"),d=a(c),p=t("../../npm/babel-runtime/helpers/classCallCheck.js"),f=a(p),h=t("../../npm/babel-runtime/helpers/createClass.js"),g=a(h),b=t("../../npm/babel-runtime/helpers/possibleConstructorReturn.js"),x=a(b),m=t("../../npm/babel-runtime/helpers/inherits.js"),v=a(m),k=t("../../npm/labrador/index.js"),w=a(k),y=t("../../components/navbar/navbar.js"),j=a(y),D=function(e){function t(){var e,a,n,r;(0,f.default)(this,t);for(var u=arguments.length,s=Array(u),o=0;o<u;o++)s[o]=arguments[o];return a=n=(0,x.default)(this,(e=t.__proto__||(0,d.default)(t)).call.apply(e,[this].concat(s))),n.data={login:!1,userInfo:{},assetsPath:w.default.app.data.assetsPath},n.children={navbar:new j.default({cur:2})},r=a,(0,x.default)(n,r)}return(0,v.default)(t,e),(0,g.default)(t,[{key:"linkTo",value:function(){function e(e){return t.apply(this,arguments)}var t=(0,l.default)(o.default.mark(function e(t){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isLink){e.next=2;break}return e.abrupt("return");case 2:return this.isLink=!0,e.next=5,w.default.app.bindLogin(t.currentTarget.dataset.link,this.data.login);case 5:this.isLink=!1;case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"bindLogin",value:function(){function e(){return t.apply(this,arguments)}var t=(0,l.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.checkLogin();case 2:case"end":return e.stop()}},e,this)}));return e}()},{key:"json2Form",value:function(e){var t=[];for(var a in e)t.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return t.join("&")}},{key:"makePhoneCall",value:function(e){w.default.app.makePhoneCall(e)}},{key:"doLogin",value:function(){function e(){return t.apply(this,arguments)}var t=(0,l.default)(o.default.mark(function e(){var t,a,n,r,s,i;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.data.login){e.next=2;break}return e.abrupt("return");case 2:if(!this.status){e.next=4;break}return e.abrupt("return");case 4:if(this.status=!0,w.default.showToast({title:"登录中",icon:"loading",duration:3e4}),a={code:w.default.app.globalData.storage.code,sessionKey:w.default.app.globalData.storage.sessionKey},a.sessionKey){e.next=16;break}return e.next=10,w.default.request({url:"https://xcx.chinamuxie.com/wxapi/user/oauth/wxLogin",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:a});case 10:return n=e.sent,e.next=13,w.default.setStorage({key:"sessionKey",data:n.data.data});case 13:return e.next=15,w.default.app.getStorage();case 15:w.default.app.globalData.storage=e.sent;case 16:return e.next=18,w.default.getUserInfo();case 18:return r=e.sent,e.next=21,w.default.request({url:"https://xcx.chinamuxie.com/wxapi/user/oauth/doOauth",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:(t={code:w.default.app.globalData.storage.code,rawData:r.rawData,signature:r.signature,encryptedData:encodeURIComponent(r.encryptedData),iv:encodeURIComponent(r.iv)},(0,u.default)(t,"code",a.code),(0,u.default)(t,"sessionKey",w.default.app.globalData.storage.sessionKey),t)});case 21:if(s=e.sent,"logged"!=s.data.data){e.next=27;break}return e.next=25,this.getUser(a.code);case 25:i=e.sent,i.data.data.loginStatus&&this.setData({login:!0,userInfo:i.data.data});case 27:if("notLogged"!=s.data.data){e.next=30;break}return e.next=30,w.default.navigateTo({url:"/pages/bindphone/bindphone"});case 30:w.default.hideToast(),this.status=!1;case 32:case"end":return e.stop()}},e,this)}));return e}()},{key:"getUser",value:function(){function e(e){return t.apply(this,arguments)}var t=(0,l.default)(o.default.mark(function e(t){var a;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w.default.request({url:"https://xcx.chinamuxie.com/wxapi/user/account",method:"get",header:{"content-type":"application/x-www-form-urlencoded"},data:{code:t}});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}},e,this)}));return e}()},{key:"checkLogin",value:function(){function e(){return t.apply(this,arguments)}var t=(0,l.default)(o.default.mark(function e(){return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.doLogin();case 2:case"end":return e.stop()}},e,this)}));return e}()},{key:"onShow",value:function(){function e(){return t.apply(this,arguments)}var t=(0,l.default)(o.default.mark(function e(){var t;return o.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUser(w.default.app.globalData.storage.code);case 2:if(t=e.sent,!t.data.data.loginStatus){e.next=7;break}this.setData({login:!0,userInfo:t.data.data}),e.next=12;break;case 7:return e.next=9,w.default.clearStorage();case 9:return e.next=11,w.default.app.__init();case 11:this.setData({login:!1});case 12:case"end":return e.stop()}},e,this)}));return e}()}]),t}(w.default.Component);Page(k._createPage(D))}(module,require);