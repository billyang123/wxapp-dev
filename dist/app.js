"use strict";!function(t,e){function a(t){return t&&t.__esModule?t:{default:t}}var r=t.exports={};window=e("./npm/labrador/global.js");Object.defineProperty(r,"__esModule",{value:!0});var n=e("./npm/babel-runtime/regenerator/index.js"),u=a(n),s=e("./npm/babel-runtime/helpers/asyncToGenerator.js"),o=a(s),c=e("./npm/babel-runtime/helpers/classCallCheck.js"),l=a(c),i=e("./npm/babel-runtime/helpers/createClass.js"),d=a(i),f=e("./npm/labrador/index.js"),p=a(f),h=(e("./utils/util.js"),function(){function t(){(0,l.default)(this,t),this.globalData={userInfo:null,storage:null},this.data={assetsPath:"https://s1.chinamuxie.com/www/assets/xcx",ajaxPath:"https://xcx.chinamuxie.com"}}return(0,d.default)(t,[{key:"onLaunch",value:function(){function t(){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(){var e;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=this,t.next=3,p.default.getStorage({key:"userInfo"});case 3:return this.globalData.userInfo=t.sent,t.next=6,this.getStorage();case 6:this.globalData.storage=t.sent;case 7:case"end":return t.stop()}},t,this)}));return t}()},{key:"dateformat",value:function(t,e,a){var r=function(t){return t=t.toString(),t[1]?t:"0"+t},n=t.getFullYear(),u=t.getMonth()+1,s=t.getDate(),o=t.getHours(),c=t.getMinutes(),l=t.getSeconds();return[n,u,s].map(r).join(e)+" "+[o,c,l].map(r).join(a)}},{key:"setHttpsUrl",value:function(t){return/wx.qlogo.cn\/mmopen\/.+\/0$/.test(t)&&(t=t.substring(0,t.length-1)+"132"),/(http|https)\:/.test(t)?t:"https:"+t}},{key:"makePhoneCall",value:function(t){p.default.showModal({title:"拨打电话："+t.currentTarget.dataset.phoneNumber,success:function(e){p.default.makePhoneCall({phoneNumber:t.currentTarget.dataset.phoneNumber})}})}},{key:"getStorage",value:function(){function t(){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(){var e,a,r,n,s;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e={},t.next=3,p.default.getStorageInfo();case 3:a=t.sent,r=a.keys,n=0;case 6:if(!(n<r.length)){t.next=14;break}return t.next=9,p.default.getStorage({key:r[n]});case 9:s=t.sent,e[r[n]]=s.data||"";case 11:n++,t.next=6;break;case 14:return t.abrupt("return",e);case 15:case"end":return t.stop()}},t,this)}));return t}()},{key:"stopAudio",value:function(){function t(){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(){var e;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.default.getBackgroundAudioPlayerState();case 2:e=t.sent,1==e.status&&p.default.stopBackgroundAudio();case 4:case"end":return t.stop()}},t,this)}));return t}()},{key:"getUserInfo",value:function(){function t(){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(){var e;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,p.default.getUserInfo();case 2:return e=t.sent,this.globalData.userInfo=e.userInfo,t.abrupt("return",e.userInfo);case 5:case"end":return t.stop()}},t,this)}));return t}()},{key:"getUser",value:function(){function t(t){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(e){var a;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.ajax({url:p.default.app.data.ajaxPath+"/wxapi/user/account",data:{code:e}});case 2:return a=t.sent,t.abrupt("return",a);case 4:case"end":return t.stop()}},t,this)}));return t}()},{key:"checkLogin",value:function(){function t(){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(){var e;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.globalData.storage||!this.globalData.storage.code){t.next=9;break}return t.next=3,this.getUser(this.globalData.storage.code);case 3:if(e=t.sent,!e){t.next=6;break}return t.abrupt("return",e.data.loginStatus);case 6:return t.abrupt("return",!1);case 9:return t.abrupt("return",!1);case 10:case"end":return t.stop()}},t,this)}));return t}()},{key:"login",value:function(){function t(t,a){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(e,a){var r,n;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=!1,!a){t.next=6;break}return t.next=4,this.getUser(this.globalData.storage.code);case 4:n=t.sent,r=n.data.loginStatus;case 6:r?e&&e(res):this.doLogin(e);case 7:case"end":return t.stop()}},t,this)}));return t}()},{key:"doLogin",value:function(){function t(t){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(e){var a,r,n,s,o;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return p.default.showToast({title:"登录中",icon:"loading",duration:1e4}),t.next=3,p.default.login();case 3:return a=t.sent,t.next=6,p.default.request({url:p.default.app.data.ajaxPath+"/wxapi/user/oauth/wxLogin",method:"post",header:{"content-type":"application/x-www-form-urlencoded"},data:{code:a.code}});case 6:if(r=t.sent,7!=r.data.status){t.next=12;break}return p.default.hideToast(),t.next=11,p.default.showModal({title:"提示",content:res.data.msg});case 11:return t.abrupt("return");case 12:return t.next=14,p.default.setStorage({key:"code",data:a.code});case 14:return t.next=16,p.default.setStorage({key:"sessionKey",data:r.data.data});case 16:return this.globalData.storage={code:a.code,sessionKey:r.data.data},t.next=19,p.default.getUserInfo();case 19:return n=t.sent,this.globalData.userInfo=n.userInfo,t.next=23,p.default.request({url:p.default.app.data.ajaxPath+"/wxapi/user/oauth/doOauth",method:"post",header:{"content-type":"application/x-www-form-urlencoded"},data:{rawData:n.rawData,signature:n.signature,encryptedData:n.encryptedData,iv:n.iv,sessionKey:r.data.data,code:a.code}});case 23:if(s=t.sent,p.default.hideToast(),"logged"!=s.data.data){t.next=34;break}return t.next=28,this.getUser(a.code);case 28:return o=t.sent,o.data&&(o.data.nickName&&(this.globalData.userInfo.nickName=o.data.nickName),o.data.headImgUrl&&(this.globalData.userInfo.avatarUrl=o.data.headImgUrl)),t.next=32,p.default.setStorage({key:"userInfo",data:this.globalData.userInfo});case 32:return e&&e(o,n),t.abrupt("return",!0);case 34:if("notLogged"!=s.data.data){t.next=37;break}return t.next=37,p.default.navigateTo({url:"/pages/bindphone/bindphone"});case 37:return t.abrupt("return",!1);case 38:case"end":return t.stop()}},t,this)}));return t}()},{key:"ajax",value:function(){function t(t){return e.apply(this,arguments)}var e=(0,o.default)(u.default.mark(function t(e){var a,r,n;return u.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return a={url:e.url,method:e.type||"get",header:{"content-type":"application/x-www-form-urlencoded"}},e.data&&(a.data=e.data),t.next=4,p.default.request(a);case 4:if(r=t.sent,200!=r.statusCode){t.next=9;break}return t.abrupt("return",r.data);case 9:if(1!=r.data.status){t.next=15;break}return n=p.default.showModal({title:"提示",content:"请先登录"}),n.confirm&&p.default.redirectTo({url:"/pages/account"}),t.abrupt("return");case 15:p.default.showModal({title:"提示",content:r.msg});case 16:case"end":return t.stop()}},t,this)}));return t}()}]),t}());r.default=h;var g=new r.default;Object.getOwnPropertyNames(g.constructor.prototype).forEach(function(t){"constructor"!==t&&(g[t]=g.constructor.prototype[t])}),App(g)}(module,require);